(()=>{"use strict";var e=document.querySelector(".page"),t=document.querySelector(".profile"),r=t.querySelector(".profile__title"),n=t.querySelector(".profile__description"),o=t.querySelector(".profile__image"),c=t.querySelector(".profile__add-button"),a=t.querySelector(".profile__edit-button"),i=t.querySelector(".profile__avatar-button"),s=document.querySelector(".places__list"),u=document.querySelector(".places__spinner"),l=document.querySelector(".popup_type_avatar"),d=document.querySelector(".popup_type_edit"),p=document.querySelector(".popup_type_new-card"),_=document.querySelector(".popup_type_image"),f=document.querySelector(".popup_type_delete-card"),m=document.forms["edit-profile"],y=document.forms["new-place"],h=document.forms.avatar,v=m.querySelector(".popup__input_type_name"),S=m.querySelector(".popup__input_type_description"),b=document.querySelector("#card-template"),q=p.querySelector(".popup__input_type_card-name"),L=p.querySelector(".popup__input_type_url"),C=l.querySelector(".popup__input_type_url"),k={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"},E={baseUrl:"https://nomoreparties.co/v1/wff-cohort-22",headers:{authorization:"414f8694-193c-4196-bcbb-74dcac9ca435","Content-Type":"application/json"}};function g(e){return e.ok?e.json():Promise.reject("Ошибка : ".concat(e.statusText))}function x(t){document.addEventListener("keydown",A),t.addEventListener("click",I),t.classList.add("popup_is-opened"),e.classList.add("page-no-scroll")}function U(t){document.removeEventListener("keydown",A),t.removeEventListener("click",I),t.classList.remove("popup_is-opened"),e.classList.remove("page-no-scroll")}function I(e){(function(e){return"popup__close"===e.target.className}(e)||function(e){return e.target.classList.contains("popup")}(e))&&U(e.currentTarget)}function A(e){(function(e){return"Escape"===e.key})(e)&&U(document.querySelector(".popup_is-opened"))}f.addEventListener("submit",(function(e){var t;e.preventDefault(),(t=B.id,fetch("".concat(E.baseUrl,"/cards/").concat(t),{method:"DELETE",headers:E.headers}).then(g)).then((function(){B.remove(),U(f)})).catch((function(e){console.error(e)}))}));var B=null;function T(e){var t=b.content.querySelector(".card").cloneNode(!0),r=t.querySelector(".card__image"),n=t.querySelector(".card__like-button"),o=t.querySelector(".card__delete-button"),c=t.querySelector(".card__title"),a=t.querySelector(".card__like-count");return t.id=e.cardItem._id,r.src=e.cardItem.link,r.alt=e.cardItem.name,c.textContent=e.cardItem.name,a.textContent=e.cardItem.likes.length,n.addEventListener("click",e.handlers.handleLikeButton),o.addEventListener("click",e.handlers.handleDeleteButton),r.addEventListener("click",(function(){e.handlers.handleCardClick(r.src,r.alt)})),e.cardItem.likes.find((function(t){return t._id===e.userId}))&&n.classList.add("card__like-button_is-active"),e.cardItem.owner._id!==e.userId&&(o.style.display="none"),t}function D(e){var t,r=e.target.closest(".card"),n=r.querySelector(".card__like-count");e.target.classList.contains("card__like-button_is-active")?function(e){return fetch("".concat(E.baseUrl,"/cards/likes/").concat(e),{method:"DELETE",headers:E.headers}).then(g)}(r.id).then((function(t){n.textContent=t.likes.length,e.target.classList.remove("card__like-button_is-active")})).catch((function(e){console.error(e)})):(t=r.id,fetch("".concat(E.baseUrl,"/cards/likes/").concat(t),{method:"PUT",headers:E.headers}).then(g)).then((function(t){n.textContent=t.likes.length,e.target.classList.add("card__like-button_is-active")})).catch((function(e){console.error(e)}))}function w(e){B=e.target.closest(".card"),x(f)}function P(e,t){Array.from(e.querySelectorAll(t.inputSelector)).forEach((function(r){r.classList.remove(t.inputErrorClass);var n=e.querySelector(".".concat(r.id,"-error"));n.classList.remove(t.errorClass),n.textContent=""}))}function N(e,t,r){!function(e){return e.some((function(e){return!e.validity.valid}))}(e)?t.classList.remove(r.inactiveButtonClass):t.classList.add(r.inactiveButtonClass)}var O,j=[fetch("".concat(E.baseUrl,"/users/me"),{headers:E.headers}).then(g),fetch("".concat(E.baseUrl,"/cards"),{headers:E.headers}).then(g)];function J(e,t){_.querySelector(".popup__image").src=e,_.querySelector(".popup__image").alt=t,_.querySelector(".popup__caption").textContent=t,x(_)}function M(e){return{cardItem:e,handlers:{handleLikeButton:D,handleDeleteButton:w,handleCardClick:J},userId:t.id}}function H(e,t){e.querySelector(".popup__button").textContent=t}function V(e){e?u.classList.add("spinner_visible"):u.classList.remove("spinner_visible")}y.addEventListener("submit",(function(e){e.preventDefault();var t,r,n,o=(t=q.value).length>1?t[0].toUpperCase()+t.slice(1).toLowerCase():t.toUpperCase(),c=L.value;H(p,"Сохранение..."),(r=o,n=c,fetch("".concat(E.baseUrl,"/cards"),{method:"POST",headers:E.headers,body:JSON.stringify({name:r,link:n})}).then(g)).then((function(e){s.prepend(T(M(e))),U(p)})).catch((function(e){console.error(e)})).finally((function(){H(p,"Сохранить")})),y.reset(),P(y,k)})),m.addEventListener("submit",(function(e){var t,o;e.preventDefault(),H(d,"Сохранение..."),(t=v,o=S,fetch("".concat(E.baseUrl,"/users/me"),{method:"PATCH",headers:E.headers,body:JSON.stringify({name:t.value,about:o.value})}).then(g)).then((function(e){r.textContent=e.name,n.textContent=e.about,U(d)})).catch((function(e){console.error(e)})).finally((function(){H(d,"Сохранить")})),P(m,k)})),h.addEventListener("submit",(function(e){e.preventDefault();var t=C.value;H(l,"Сохранение..."),function(e){return fetch("".concat(E.baseUrl,"/users/me/avatar"),{method:"PATCH",headers:E.headers,body:JSON.stringify({avatar:e})}).then(g)}(t).then((function(e){o.setAttribute("style","background-image: url(".concat(e.avatar,")")),U(l)})).catch((function(e){console.error(e)})).finally((function(){H(l,"Сохранить")}))})),c.addEventListener("click",(function(){y.reset(),P(y,k),x(p)})),a.addEventListener("click",(function(){v.value=r.textContent,S.value=n.textContent,P(m,k),x(d)})),i.addEventListener("click",(function(){h.reset(),P(h,k),x(l)})),V(!0),Promise.all(j).then((function(e){t.id=e[0]._id,o.setAttribute("style","background-image: url(".concat(e[0].avatar,")")),r.textContent=e[0].name,n.textContent=e[0].about,e[1].forEach((function(e){s.append(T(M(e)))}))})).catch((function(e){console.error(e)})).finally((function(){V(!1)})),O=k,Array.from(document.querySelectorAll(O.formSelector)).forEach((function(e){!function(e,t){var r=Array.from(e.querySelectorAll(t.inputSelector)),n=e.querySelector(t.submitButtonSelector);N(r,n,t),r.forEach((function(o){o.addEventListener("input",(function(){!function(e,t,r){t.validity.patternMismatch?t.setCustomValidity(t.dataset.errorMessage):t.setCustomValidity(""),t.validity.valid?function(e,t,r){var n=e.querySelector(".".concat(t.id,"-error"));t.classList.remove(r.inputErrorClass),n.classList.remove(r.errorClass),n.textContent=""}(e,t,r):function(e,t,r,n){var o=e.querySelector(".".concat(t.id,"-error"));t.classList.add(n.inputErrorClass),o.textContent=r,o.classList.add(n.errorClass)}(e,t,t.validationMessage,r)}(e,o,t),N(r,n,t)}))}))}(e,O)}))})();